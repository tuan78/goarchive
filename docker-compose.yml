services:
  # PostgreSQL database for testing
  postgres:
    image: postgres:16-alpine
    container_name: backup-test-postgres
    environment:
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: testdb
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d testdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LocalStack for S3 testing (alternative to real AWS)
  localstack:
    image: localstack/localstack:latest
    container_name: backup-test-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock

  # GoArchive application (S3 storage) - One-time backup
  goarchive:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: goarchive
    command: backup
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_started
    environment:
      # Database configuration
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: testuser
      DB_PASSWORD: testpass
      DB_DATABASE: testdb
      DB_SSLMODE: disable

      # Storage configuration (using LocalStack)
      STORAGE_TYPE: s3
      STORAGE_BUCKET: backups
      STORAGE_REGION: us-east-1
      STORAGE_ACCESS_KEY: test
      STORAGE_SECRET_KEY: test
      STORAGE_PREFIX: db-backups/
      STORAGE_ENDPOINT: http://localstack:4566
    # One-time backup - runs and exits
    profiles:
      - oneshot

  # GoArchive application (Disk storage) - One-time backup
  goarchive-disk:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: goarchive-disk
    command: backup
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database configuration
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: testuser
      DB_PASSWORD: testpass
      DB_DATABASE: testdb
      DB_SSLMODE: disable

      # Storage configuration (using disk)
      STORAGE_TYPE: disk
      STORAGE_PATH: /root/backups
    volumes:
      - backup-data:/root/backups
    # One-time backup - runs and exits
    profiles:
      - oneshot

  # GoArchive scheduled backups (Disk storage) - Keeps running
  goarchive-scheduled:
    build:
      context: .
      dockerfile: Dockerfile.scheduler
    container_name: goarchive-scheduled
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database configuration
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: testuser
      DB_PASSWORD: testpass
      DB_DATABASE: testdb
      DB_SSLMODE: disable

      # Storage configuration (using disk)
      STORAGE_TYPE: disk
      STORAGE_PATH: /root/backups

      # Scheduling (choose one):
      # Option 1: Cron expression (default: every 6 hours)
      BACKUP_SCHEDULE: "0 */6 * * *"
      # Option 2: Interval in seconds (uncomment to use instead of cron)
      # BACKUP_INTERVAL: "3600"  # Every 1 hour
    volumes:
      - backup-data:/root/backups

  # GoArchive scheduled backups (S3 storage) - Keeps running
  goarchive-scheduled-s3:
    build:
      context: .
      dockerfile: Dockerfile.scheduler
    container_name: goarchive-scheduled-s3
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_started
    environment:
      # Database configuration
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: testuser
      DB_PASSWORD: testpass
      DB_DATABASE: testdb
      DB_SSLMODE: disable

      # Storage configuration (using LocalStack)
      STORAGE_TYPE: s3
      STORAGE_BUCKET: backups
      STORAGE_REGION: us-east-1
      STORAGE_ACCESS_KEY: test
      STORAGE_SECRET_KEY: test
      STORAGE_PREFIX: db-backups/
      STORAGE_ENDPOINT: http://localstack:4566

      # Scheduling (choose one):
      # Option 1: Cron expression (default: every 6 hours)
      BACKUP_SCHEDULE: "0 */6 * * *"
      # Option 2: Interval in seconds (uncomment to use instead of cron)
      # BACKUP_INTERVAL: "21600"  # Every 6 hours
    profiles:
      - scheduled

volumes:
  postgres-data:
  localstack-data:
  backup-data:
